<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Plotting workload distribution</title>
  <!-- Font Awesome 
    <script defer src="https://use.fontawesome.com/releases/v5.14.0/js/all.js"></script>
  -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
  <link rel="stylesheet" href="index.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/8.1.0/math.js"></script>
  <!-- Load plotly.js into the DOM -->
  <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
  <!-- Load katex.js into the DOM -->
  <!-- 
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.css" integrity="sha384-2vkq42dvFAQl88n6UuPWLKSKnFnHyyoSgy788ohlfWZ4xEmF8g0kCMZe1CkaXHDd" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.js" integrity="sha384-PFWG8XW41D5NzhNv5FegM1CUkw9nNLdWug8DuwnUoNEVop9n5frjcnbtsZtxTNjw" crossorigin="anonymous"></script> 
   -->
  <link rel="stylesheet" href="assets/katex/katex.min.css">
  <script defer src="assets/katex/katex.min.js"></script> 
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title">Virtual Queueing Time distribution</h1>
      <p class="subtitle">Generates the plots of the Virtual Queueing Time distributions of a special kind of queueing system.</p>
      <p>This queueing system has <b>c</b> servers and an arrival stream of customers of Poisson type with homogeneous parameter <b>&lambda;</b>.</p>
      <p>Whenever a customer arrives it is tagged as <i>customer of type <b>1</b></i> on arrival the workload is below the threshold <b>k</b>, otherwise it is tagged as <i>customer of type <b>2</b></i>.</p>
      <p>All customers have a service time exponential distributed, type 1 customers with parameter <b>&mu;<sub>1</sub></b> and type 2 customers with parameter <b>&mu;<sub>2</sub></b>.</p>
  </div>
  </section>

  <div id="tabs-with-content">
  <div class="tabs is-toggle is-large is-centered is-size-5-mobile">
    <ul>
      <li class="is-active" data-tab="CDF"><a>Distribution</a></li>
      <li data-tab="PDF"><a>Density</a></li>
      <li data-tab="Mean"><a>Mean</a></li>
      <li data-tab="MathML"><a>Math</a></li>
    </ul>
  </div>

  <section class="main-content columns is-fullheight is-active" data-content="CDF">
  
    <aside class="column is-2 is-fullheight section">
      <p class="menu-label">Parameters</p>
      <ul class="menu-list">
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_c" value="3">  
          <span class="icon is-left">c</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_lambda" value="2">  
          <span class="icon is-left">&lambda;</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu1" value="0.8">  
          <span class="icon is-left">&mu;<sub>1</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu2" value="0.7;0.8;0.9">
          <span class="icon is-left">&mu;<sub>2</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_k" value="5">  
          <span class="icon is-left">k</span>
        </li>
        <li class="button is-link is-outlined is-fullwidth" data-ID="btn_draw" onclick="updateContent('CDF');"/>
          Draw
        </li>
      </ul>
    </aside>
  
    <div class="container column is-10">
      <div class="section">
        
        <div class="card is-hidden1">
          <div class="card-header"><p class="card-header-title">CDF of the VQT</p></div>
          <div class="card-content">
            <div class="content" data-ID="root"></div>
          </div>
        </div>
        <br />
        
      </div>
    </div>
    
  </section>

  <section class="main-content columns is-fullheight" data-content="PDF">
  
    <aside class="column is-2 is-fullheight section">
      <p class="menu-label">Parameters</p>
      <ul class="menu-list">
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_c" value="3">  
          <span class="icon is-left">c</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_lambda" value="2">  
          <span class="icon is-left">&lambda;</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu1" value="0.3;0.6;0.67;0.74;0.8">  
          <span class="icon is-left">&mu;<sub>1</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu2" value="0.8">
          <span class="icon is-left">&mu;<sub>2</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_k" value="5">  
          <span class="icon is-left">k</span>
        </li>
        <li class="button is-link is-outlined is-fullwidth" data-ID="btn_draw" onclick="updateContent('PDF');"/>
          Draw
        </li>
      </ul>
    </aside>
  
    <div class="container column is-10">
      <div class="section">
        
        <div class="card is-hidden1">
          <div class="card-header"><p class="card-header-title">PDF of the VQT</p></div>
          <div class="card-content">
            <div class="content" data-ID="root"></div>
          </div>
        </div>
        <br />
        
      </div>
    </div>
    
  </section>

  <section class="main-content columns is-fullheight" data-content="Mean">
  
    <aside class="column is-2 is-fullheight section">
      <p class="menu-label">Parameters</p>
      <ul class="menu-list">
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_c" value="3">  
          <span class="icon is-left">c</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_rhoMin" value="0.3">  
          <span class="icon is-left"><span style="font-size: x-small;">Min</span>&rho;</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_rhoMax" value="0.7">  
          <span class="icon is-left"><span style="font-size: x-small;">Max</span>&rho;</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu1" value="0.8">  
          <span class="icon is-left">&mu;<sub>1</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu2" value="0.7;0.8;0.9">
          <span class="icon is-left">&mu;<sub>2</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_k" value="5">  
          <span class="icon is-left">k</span>
        </li>
        <li class="control checkbox has-icons-left input">
          <input type="checkbox" name="logscale" checked="checked">
          Log scale
        </li>
        <li class="button is-link is-outlined is-fullwidth" data-ID="btn_draw" onclick="updateContent('Mean');"/>
          Draw
        </li>
      </ul>
    </aside>
  
    <div class="container column is-10">
      <div class="section">
        
        <div class="card is-hidden1">
          <div class="card-header"><p class="card-header-title">Mean Virtual Queueing Time</p></div>
          <div class="card-content">
            <div class="content" data-ID="root"></div>
          </div>
        </div>
        <br />
        
      </div>
    </div>
    
  </section>

  <section class="main-content columns is-fullheight" data-content="MathML">
  
    <aside class="column is-2 is-fullheight section">
      <p class="menu-label">Parameters</p>
      <ul class="menu-list">
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_c" value="2">  
          <span class="icon is-left">c</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_lambda" value="2">  
          <span class="icon is-left">&lambda;</span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu1" value="0.75">  
          <span class="icon is-left">&mu;<sub>1</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_mu2" value="1.12">
          <span class="icon is-left">&mu;<sub>2</sub></span>
        </li>
        <li class="control has-icons-left">
          <input class="input" type="text" name="param_k" value="0.45">  
          <span class="icon is-left">k</span>
        </li>
        <li class="button is-link is-outlined is-fullwidth" data-ID="btn_draw" onclick=""/>
          Generate
        </li>
      </ul>
    </aside>
  
    <div class="container column is-10">
      <div class="section">
        
        <div class="card is-hidden1">
          <div class="card-header"><p class="card-header-title">Mean Virtual Queueing Time</p></div>
          <div class="card-content">
            <div class="content" data-ID="root"></div>
          </div>
        </div>
        <br />
        
      </div>
    </div>
    
  </section>
</div>
  
  <footer class="footer">
    <div class="content">
      <span>Open the <a href="index-pyodide.html">Pyodide</a> version.</span> 
      <span>Open the <a href="https://github.com/brdauria/VQTPlot" target="_blank">Github repository</a>.</span> 
    </div>
  </footer>
  
  <script src="assets/js/vcqt.js"></script>
  <script> 
    var lambda, mu1, mu2, k, c;
    var validated ={'CDF':false, 'PDF':false, 'Mean':false, 'MathML':false}

    function remove_danger_light(el, bool) {
      if (bool) el.classList.remove('has-background-danger-light')
        else el.classList.add('has-background-danger-light');
      return bool
    }

    function read_param(s) {
      return s.split(";").map(parseFloat)
    }

    function assign_param(el) {
      let name = el.name.substring(6)
      let value = read_param(el.value)
      eval(`${name}=[${value}]`);
      eval(`el${capitalized(name)}=el`);
    }

    function is_correct(v,n) {
      if (typeof(n) == "undefined") n = n_curves
      res = v.length == 1 || v.length == n
      res = res && v.every(x=>x>0) 
      return res 
    }

    function is_in(v,min=0,max=1,n) {
      if (typeof(n) == "undefined") n = n_curves
      res = v.length == 1 || v.length == n
      res = res && v.every(x=> (x > min) && (x<max)) 
      return res 
    }

    function get(v,n) {
      return (v.length == 1) ? v[0] : v[n]
    }

    function get_legend_entry(n) {
      res = ""
      if (c.length != 1) res += `c=${c[n]}`
      if (lambda.length != 1) {
        if (res!="") res+=", "
        res += `\u03BB=${lambda[n]}`
      }
      if (mu1.length != 1) {
        if (res!="") res+=", "
        res += `\u03BC1=${mu1[n]}`
      }
      if (mu2.length != 1) {
        if (res!="") res+=", "
        res += `\u03BC2=${mu2[n]}`
      }
      return res
    }

    function checkData(tab="CDF") {
      const section = document.querySelector(`section[data-content=${tab}]`);
      section.querySelectorAll("input[name^='param_']").forEach(assign_param);
      var result =  true;
      n_curves = (tab=="MathML") ? 1 : Math.max(...[lambda, mu1, mu2, k, c].map(x => x.length));
      result &= remove_danger_light(elC, is_correct(c))
      result &= remove_danger_light(elMu1, is_correct(mu1))
      result &= remove_danger_light(elMu2, is_correct(mu2))
      result &= remove_danger_light(elK, is_correct(k))
      
      if (tab=="Mean") {
        result &= remove_danger_light(elRhoMin, is_in(rhoMin,0.05,0.95,1))
        result &= remove_danger_light(elRhoMax, is_in(rhoMax,0.05,0.95,1))
        return result; // as the other checks are on lambda
      }

      result &= remove_danger_light(elLambda, is_correct(lambda))
      for (var ix = 0; ix < n_curves; ix++){
        if (approxeq(get(lambda,ix),get(c,ix)*get(mu1,ix))) {
          result=false; 
          remove_danger_light(elLambda, false)
          remove_danger_light(elMu1, false)
          break
        }
        if (approxeq(get(lambda,ix),get(c,ix)*(get(mu1,ix)-get(mu2,ix)))) {
          result=false; 
          remove_danger_light(elLambda, false)
          remove_danger_light(elMu1, false)
          remove_danger_light(elMu2, false)
          break
        }
        if (get(lambda,ix) >= get(mu2,ix)*get(c,ix)) {
          result=false; 
          remove_danger_light(elLambda, false)
          remove_danger_light(elMu2, false)
          break
        }
      }
      return result;
    }

    function updateMathML(tab, section) {
      let div = section.querySelector("div[data-ID='root']");
      console.log("ole")
      katex.render("c = \\pm\\sqrt{a^2 + b^2}", div, {throwOnError: true});
    }

    function updateGraph(tab, section) {
      let xpoints, ypoints
      var layout = {
        font: {size: 12}, 
        margin: {l: 5, r: 5, b: 25, t: 60, pad: 4},
        showlegend: true,
        legend: { x: 1, xanchor: 'right', y: 0.1}
      };
      if (tab == "Mean") {
        let checkbox = section.querySelector("input[name='logscale']");
        if (checkbox.checked) layout.yaxis = {type: 'log', autorange: true}
      }
      else layout.shapes = k.map(ik => {return {
        type: 'line', 
        x0: ik, y0: 0,  x1: ik, yref: 'paper', y1: 1,
        line: { color: 'grey', width: 1.5, dash: 'dot'}}})
      let config = {responsive: true}
      let data = []
      for (var ix = 0; ix < n_curves; ix++){
        if (tab=="Mean") {
          xpoints = range(100).map(x=>(x/100*(rhoMax[0]-rhoMin[0])+rhoMin[0]));
          plotf = x => workload(get(c,ix), x * get(c,ix) * get(mu2,ix), get(mu1,ix), get(mu2,ix), get(k,ix))["Mean"]
          ypoints = xpoints.map(plotf);
        } else {
          let wfun = workload(get(c,ix), get(lambda,ix), get(mu1,ix), get(mu2,ix), get(k,ix));
          xpoints= range(250).map(x=>x*5*get(k,ix)/250);
          ypoints = xpoints.map(wfun[tab]);
        }
        var trace = {
          name: get_legend_entry(ix),
          x: xpoints,
          y: ypoints,
          type: 'scatter'
        }
        if (get(mu1,ix) == get(mu2,ix)) {trace.line = {dash: 'dashdot', width: 2}}
        data.push(trace)
      }
      let div = section.querySelector("div[data-ID='root']");
      Plotly.newPlot(div, data, layout, config);
    }

    async function updateContent(tab) {
      if (!checkData(tab)) return false;
      const section = document.querySelector(`section[data-content=${tab}]`);
      let el = section.querySelector("li[data-ID='btn_draw']");
      el.disabled = true;
      el.innerHTML = 'computing...';
      console.log(tab)
      if (tab=="MathML") updateMathML(tab, section)
      else updateGraph(tab, section)
      el.innerHTML = "Update";
      el.disabled = false;
      validated[tab] = true;
    }

    var cmin = 2;
    var cspread = 3;
    var ready= false;
    var lambda, mu1, mu2, k, c, n_curves, rhoMin, rhoMax;
    var elLambda, elMu1, elMu2, elK, elC, elRhoMin, elRhoMax;

    // MANAGING TABS
    const TABS = [...document.querySelectorAll('div.tabs li')];
    const CONTENT = [...document.querySelectorAll('section.main-content')];
    const ACTIVE_CLASS = 'is-active';

    function initTabs() {
        TABS.forEach((tab) => {
          tab.addEventListener('click', (e) => {
            let selected = tab.getAttribute('data-tab');
            updateActiveTab(tab);
            updateActiveContent(selected);
          })
        })
        updateContent('CDF')
    }

    function updateActiveTab(selected) {
      TABS.forEach((tab) => {
        if (tab && tab.classList.contains(ACTIVE_CLASS)) {
          tab.classList.remove(ACTIVE_CLASS);
        }
      });
      selected.classList.add(ACTIVE_CLASS);
    }

    function updateActiveContent(selected) {
      CONTENT.forEach((item) => {
        if (item && item.classList.contains(ACTIVE_CLASS)) {
          item.classList.remove(ACTIVE_CLASS);
        }
        let data = item.getAttribute('data-content');
        if (data === selected) {
          item.classList.add(ACTIVE_CLASS);
          if (!validated[selected]) updateContent(selected)
        }
      });
    }

    initTabs();
  </script>
</body>
</html>